# AT-007: Event Ingestion (MVP Slice)

## Ziel
HTTP-Endpoint `ingestEvent` akzeptiert Checkout-/Order-Events per **POST JSON** und speichert sie als Dokument in `events` (Firestore, Emulator). Minimal valide Felder:
- `tenantId` (string, required)
- `type` (string, required; z. B. `cart_abandon` | `order_placed`)
- `refId` (string, required; z. B. cartId/orderId)
- `amount` (number, required; >= 0)
- `ts` (ISO-8601, optional; Server setzt, falls fehlt)

Persistiertes Schema:
```json
{
  "tenantId": "...",
  "type": "...",
  "refId": "...",
  "amount": 123.45,
  "ts": "<ISO-8601>",
  "source": "api"
}
Response (201):

json
Code kopieren
{ "ok": true, "id": "<auto-id>" }
Scope
In-Scope: functions/index.js (neue Funktion + sehr einfache Inline-Validierung)

Out-of-Scope: externe Validatoren/Libs, Auth, Firestore Rules, GCP-Deploy, Mixpanel/Postmark

Inputs
POST application/json wie oben.

Output
Firestore (Emulator): neues Dokument in events.

HTTP 201 JSON { ok: true, id }. Bei Bad Request: HTTP 400 JSON { error: "bad_request", details: [...] }.

Tests
Emulator starten: npm run emu --prefix functions

Happy Path:

bash
Code kopieren
curl -s -X POST "http://127.0.0.1:5001/recovery-engine/europe-west1/ingestEvent" \
  -H "Content-Type: application/json" \
  -d '{"tenantId":"t1","type":"cart_abandon","refId":"c123","amount":12.34}'
Erwartet: HTTP 201, JSON { ok: true, id: "..." }. In UI (http://127.0.0.1:4000/firestore) neues events-Dokument mit Feldern inkl. ts und source:"api".

Negativ:

bash
Code kopieren
curl -s -o - -w "\n%{http_code}\n" -X POST \
  "http://127.0.0.1:5001/recovery-engine/europe-west1/ingestEvent" \
  -H "Content-Type: application/json" \
  -d '{"tenantId":"t1","type":"","refId":"","amount":-1}'
Erwartet: HTTP 400, JSON { error:"bad_request", details:[...] }.

Definition of Done
Bestehende Endpoints (helloWorld, lostRevenueMock, eventWriteMock, eventsList) unverändert funktionsfähig.

Nur functions/index.js geändert.

Node 22, Region europe-west1.

Lokale Tests grün. CI-Smoketest bleibt grün.
